{% extends 'userside/baseuser.html' %}
{% load static %}
{% block style %}
<style>
/* Custom CSS for border and text color */
.card-body {
    border-color: rgba(0, 128, 0, 0.5); 
    color: black; 
}
</style>
{% endblock style %}
{% block content1%} checkout{% endblock content1 %}
{% block content %}

<div id="site-main" class="site-main">
    <div id="main-content" class="main-content">
        <div id="primary" class="content-area">
            <div id="title" class="page-title">
                <div class="section-container">
                    <div class="content-title-heading">
                        <h1 class="text-title-heading">
                            Checkout
                        </h1>
                    </div>
                    <div class="breadcrumbs">
                        <a href="index.html">Home</a><span class="delimiter"></span><a href="shop-grid-left.html">Shop</a><span class="delimiter"></span>Shopping Cart
                    </div>
                </div>
            </div>

            <div id="content" class="site-content" role="main">
                <div class="section-padding">
                    <div class="section-container p-l-r">
                        <div class="shop-checkout">
                             <a href="{% url 'addAddress' %}"> <button class="btn btn-success mb-4">Add Address</button></a>
                                <div class="row">
                                    
                                    <form class="col-xl-8 col-lg-7 d-flex flex-column  col-md-12 col-12">
                                       
                                        <div class=" mb-3 col-xl-12 col-lg-12 " >
                                            {% for address in addresses %}
                                                <div class="form-check address-item card-body" style='border: 1px solid rgba(0,0,0,.125);'>
                                                    <div class='p-3'>
                                                    <input type="radio" class="form-check-input" id="address_{{ address.id }}" name="selected_address" value="{{ address.id }}" {% if forloop.first %}checked{% endif %}>
                                                    <label class="form-check-label" for="address_{{ address.id }}"  style='margin-left:30px!important;'>
                                                        <strong>Name:</strong> {{address.name}}<br>
                                                        {{address.street_address}}<br>
                                                        {{address.city}},{{address.state}}- {{address.pin_code}}<br>
                                                        Phone: {{address.phone}}<br>    
                                                        <button type="button" class="btn btn-outline-secondary mt-2">
                                                            <a href="../editAddress/{{ address.id }}" class="edit" style="text-decoration: none; color: inherit;">
                                                                Edit
                                                            </a>
                                                        </button>                            
                                                        </button>
                                                    </label>
                                                    </div>
                                                </div>
                                                
                                            {% endfor %}
                                        </div>
                                        
                                    </form>

                                    <div class="col-xl-4 col-lg-5 col-md-12 col-12">
                                        <div class="checkout-review-order">
                                            <div class="checkout-review-order-table">
                                                <div class="review-order-title">Product</div>
                                                <div class="cart-items">
                                                    {% for item in cart_items %}
                                                    <div class="cart-item">
                                                        <div class="info-product">
                                                            {% comment %} <div class="product-thumbnail">
                                                                <img width="600" height="600" src="media/product/3.jpg" alt="">					
                                                            </div> {% endcomment %}
                                                            <div class="product-name">
                                                               product:{{item.product.products_name}}
                                                                <strong class="product-quantity">quantity:{{item.quantity}}</strong>											
                                                            </div>
                                                        </div>
                                                        <div class="product-total">
                                                            <span>${{item.product.price}}</span>
                                                        </div>
                                                    </div>
                                                    {% endfor %}

                                                    {% comment %} <div class="cart-item">
                                                        <div class="info-product">
                                                            <div class="product-thumbnail">
                                                                <img width="600" height="600" src="{% static "media/product/1.jpg" %}" alt="">					
                                                            </div>
                                                            <div class="product-name">
                                                                Zunkel Schwarz
                                                                <strong class="product-quantity">QTY : 1</strong>											
                                                            </div>
                                                        </div>
                                                        <div class="product-total">
                                                            <span>$180.00</span>
                                                        </div>
                                                    </div> {% endcomment %}
                                                </div>
                                                <div class="cart-subtotal">
                                                    <h2>Subtotal</h2>
                                                    <div class="subtotal-price">
                                                        <span>${{total}}</span>
                                                    </div>
                                                </div>
                                                <div class="shipping-totals shipping">
                                                    <h2>Shipping</h2>
                                                    <div data-title="Shipping">
                                                        <ul class="shipping-methods custom-radio">
                                                            <li>
                                                                <input type="radio" name="shipping_method" data-index="0" value="free_shipping" class="shipping_method" checked="checked"><label>Free shipping</label>
                                                            </li>
                                                            {% comment %} <li>
                                                                <input type="radio" name="shipping_method" data-index="0" value="flat_rate" class="shipping_method"><label>Flat rate</label>					
                                                            </li> {% endcomment %}
                                                        </ul>
                                                    </div>
                                                </div>
                                                <div class="order-total">
                                                    <h2>Total</h2>
                                                    <div class="total-price" id="total1">
                                                        <strong>
                                                            <span>${{total}}</span>
                                                        </strong> 
                                                    </div>
                                                </div>
                                            </div>
                                            <div id="payment" class="checkout-payment">
                                                <ul class="payment-methods methods custom-radio">
                                                    <li class="payment-method">
                                                        <input type="radio" class="input-radio" name="payment_method" value="Razorpay" checked="checked">
                                                        <label for="payment_method_bacs">Razor pay</label>
                                                        <div class="payment-box">
                                                            <p>Please use your Order ID as the payment reference. Your order will not be shipped until the funds have cleared in our account.</p>
                                                        </div>
                                                    </li>
                                                    {% comment %} <li class="payment-method">
                                                        <input type="radio" class="input-radio" name="payment_method" value="cheque">
                                                        <label>Check payments</label>
                                                        <div class="payment-box">
                                                            <p>Please send a check to Store Name, Store Street, Store Town, Store State / County, Store Postcode.</p>
                                                        </div>
                                                    </li> {% endcomment %}
                                                    <li class="payment-method">
                                                        <input type="radio" class="input-radio" name="payment_method" value="cod" checked>
                                                        <label>Cash on delivery</label>
                                                        <div class="payment-box">
                                                            <p>Pay with cash upon delivery.</p>
                                                        </div>
                                                    </li>
                                                    {% comment %} <li class="payment-method">
                                                        <input type="radio" class="input-radio" name="payment_method" value="paypal">
                                                        <label>PayPal</label>
                                                        <div class="payment-box">
                                                            <p>Pay via PayPal; you can pay with your credit card if you donâ€™t have a PayPal account.</p>
                                                        </div>
                                                    </li> {% endcomment %}
                                                </ul>
                                                <div class="form-row place-order">
                                                    <div class="terms-and-conditions-wrapper">
                                                        <div class="privacy-policy-text"></div>
                                                    </div>
                                                    <button type="" id="placeOrderButton"  class="button alt" name="checkout_place_order" value="Place order">Place order</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                        </div>
                    </div>
                </div>
            </div><!-- #content -->
        </div><!-- #primary -->
    </div><!-- #main-content -->
</div>

{% block contentscript%}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>


<script>

    $(document).ready(function() {
        $("#placeOrderButton").off("click").on("click", function(event) {
            event.preventDefault(); // Prevent default form submission
    
          console.log("Button Clicked!");

          // Your existing code
          console.log("clicked");
          var address = $("input[name=selected_address]:checked").val();
          var total = $("#total1").text();
          var payment = $("input[name=payment_method]:checked").val();
          console.log('button clicked');
          console.log(address, "address");
          var cartIsEmpty =  {% if cart_items %}false{% else %}true{% endif %};

          if (cartIsEmpty) {
            alert("Your cart is empty. Please add items to your cart before placing an order.");
            return;   
          }
            
            console.log('Before AJAX request');
            // Get the CSRF token
            var csrf_token = $("[name=csrfmiddlewaretoken]").val();

            // Send the data using jQuery AJAX
            if (payment === "Razorpay") {

                $.ajax({
                    method: "GET",
                    url: "/procceed_to_pay",
                    success:function(response){
                        console.log('ddddddddddddddddddddddddddddddddddddddddddddddddd')

                        var options = {
                            "key": "rzp_test_VlRkBL8cA77GO1", // Enter the Key ID generated from the Dashboard
                            "amount":response.total_price*100, // Amount is in currency subunits. Default currency is INR. Hence, 50000 refers to 50000 paise
                            "currency": "INR",
                            "name": "Ruper", //your business name
                            "description": "Thank you for buting from us",
                            "image": "https://example.com/your_logo",
                    //      "order_id": "order_9A33XWu170gUtm", //This is a sample Order ID. Pass the `id` obtained in the response of Step 1
                            "handler": function (responseb){
                                $.ajax({
                                    type: "POST",
                                    url: "/place_order/",
                                    data: {
                                        total: total,
                                        address: address,
                                        payment: payment,
                                        csrfmiddlewaretoken: csrf_token,
                                    },
                                    success: function(response) {
                                        console.log("entered");
                                        if (response && response.success === true) {
                                            console.log("order_success");
                                        
                                        // Check if the payment method is Razorpay
                                           location.reload(true);

                                            // Redirect to the success page for other payment methods
                                            window.location.href = '/order_success/';
                                        
                                        } 
                                        else{
                                        alert(" stock is not available")
                                    }
                                    }
                                });
                            
                            },
                            "prefill": { //We recommend using the prefill parameter to auto-fill customer's contact information, especially their phone number
                                "name": response.name, //your customer's name
                                "email": response.email, 
                                "contact": response.contact  //Provide the customer's phone number for better conversion rates 
                            },
                            
                            "theme": {
                                "color": "#3399cc"
                            }
                        };
                        var rzp1 = new Razorpay(options);
                        console.log('eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee')
                        rzp1.open();
                        console.log('fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff')


                    }
                })

                
            }
            else{
            $.ajax({
                type: "POST",
                url: "/place_order/",
                data: {
                    total: total,
                    address: address,
                    payment: payment,
                    csrfmiddlewaretoken: csrf_token,
                },
                success: function(response) {
                    console.log("entered");
                    if (response && response.success === true) {
                        console.log("order_success");
                        
                        // Check if the payment method is Razorpay
                            location.reload(true);
                            // Redirect to the success page for other payment methods
                            window.location.href = '/order_success/';
                        
                    } 
                    else{
                        alert(" stock is not available")
                    }
                }
            });

            }

    console.log('After AJAX request');



           
        });
  });
 
</script>

<script>
    // Check if the page has been reloaded before
    var hasReloaded = document.cookie.indexOf('reloadFlag=1') !== -1;

    // Reload the entire page if it hasn't been reloaded before
    if (!hasReloaded) {
        // Set a cookie to track that the page has been reloaded
        document.cookie = 'reloadFlag=1; max-age=3600';  // Set an expiry time (e.g., 1 hour)

        // Reload the page
        location.reload(true);  // The true parameter forces a reload from the server
    }
</script>


   

{% endblock contentscript%}



{% endblock content %}